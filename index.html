



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.1.1">
    
    
      
        <title>Netguru Interview - Post-Mortem Example</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,400i,700|">
        <style>body,input{font-family:"Work Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#introduction" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Netguru Interview - Post-Mortem Example" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Netguru Interview - Post-Mortem Example
            </span>
            <span class="md-header-nav__topic">
              Overview
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/netguru-interview/post-mortem/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="Netguru Interview - Post-Mortem Example" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Netguru Interview - Post-Mortem Example
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/netguru-interview/post-mortem/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="." title="Overview" class="md-nav__link md-nav__link--active">
      Overview
    </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/netguru-interview/post-mortem/edit/master/docs/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>On September 21st, 2020, we have experienced a major service outage for
our company's corporate website - Smart-Foodies-Shop.com. The outage was
caused by an accidental removal of system data from our database server.
This incident caused the service to be unavailable for a couple of
hours. We also lost some production data that we were eventually unable
to recover.</p>
<h1 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h1>
<p>Smart-Foodies-Shop.com used a single MySQL database instance running on
EC2 as a production database server. For security reasons there was a
business decision made to host a database on a single, separate compute
instance. It's installed natively on the host and backed exclusively by
instance storage. In this setup a single database has to handle all the
load, which is not ideal.</p>
<p>Related architecture is depicted below.</p>
<p><a href="assets/infrastructure_architecture.png"><img alt="" src="assets/infrastructure_architecture.png" /></a></p>
<h1 id="timeline">Timeline<a class="headerlink" href="#timeline" title="Permanent link">&para;</a></h1>
<p>On September 21st, 2020 an engineer started onboarding process onto RDS,
to which our company is planning to migrate. The plan was to try out new
managed solution and compare it with existing one to see if we could
benefit from better performance and minimize load on our database.</p>
<p>± 16:00 UTC: prior to starting this work, our engineer decided to dump
the production database using custom shell script. This was required to
ensure the new RDS instance would be up to date. Daily dumps however
normally happen automatically once every 24 hours and are later uploaded
to S3, but this time it was necessary to have a more up to date copy of
the database.</p>
<p>± 17:00 UTC: Smart-Foodies-Shop.com starts experiencing an increase in
database load due to what we suspect was an overly complicated SQL
export query consisting of multiple <code>JOIN</code> sub-queries resulting in huge
temporary table being generated. One of the problems this load caused
was that many customers were not able to finish their purchases on our
website. Getting the load under control took several hours.</p>
<p>± 17:20 UTC: one of the engineers thinks that perhaps export script had
created some files in the MySQL data directory during the previous
attempts to run it. While normally dump script just exports entire
database without altering its content, this time engineer decided to
slightly modify its logic and extract only product-specific data, hence
trying to remove various client-related tables and purchase histories.
This resulted in an utterly large disk consumption being occupied by
<code>/var/lib/mysql</code> directory in at attempt of MySQL Engine to process
<code>JOIN</code> query, which later had filled in entire disk space to its maximum
extent.</p>
<p>Trying to restore the space consumption, an engineer proceeds to wipe
the <code>/var/lib/mysql</code> directory, thinking this is <code>/var/log/mysql</code>. A
second after, understanding what is happening, the engineer terminated
the process but at this point around 50 GB of data had already been
removed.</p>
<h1 id="recovery-procedures">Recovery Procedures<a class="headerlink" href="#recovery-procedures" title="Permanent link">&para;</a></h1>
<p>In our case we have the following procedures in place:</p>
<p>Every 24 hours we generate a backup of production database. This backup
is then uploaded into S3, allowing us to restore a database in
relatively little time.</p>
<p>At the time of the outage we had one backup available: a backup created
almost 24 hours before the situation happened.</p>
<h1 id="recovering-smart-foodies-shopcom">Recovering Smart-Foodies-Shop.com<a class="headerlink" href="#recovering-smart-foodies-shopcom" title="Permanent link">&para;</a></h1>
<p>To recover we decided to use the aforementioned backup created 24 hours
before the outage, as it was our only option. The restoration process
included:</p>
<ul>
<li>spin up a new EC2 instance using the same AMI as production database
    server</li>
<li>rsync missing <code>/var/lib</code> parts that had accidentally been deleted</li>
<li>copy over the existing latest backup from S3 onto production and
    restore database from it</li>
<li>gradually re-enable existing web services</li>
</ul>
<p>On September 22nd at 02:00 UTC we managed to restore the
Smart-Foodies-Shop.com server and database.</p>
<h1 id="data-loss-impact">Data Loss Impact<a class="headerlink" href="#data-loss-impact" title="Permanent link">&para;</a></h1>
<p>Database data such as users, comments and orders created between
September 21st 16:20 UTC and Sepm 22nd 02:30 UTC has been lost. It's
hard to estimate how much data has been lost exactly, but we estimate we
have lost at least 100 new users, 500 comments, and roughly 1000 orders.</p>
<h1 id="root-cause-analysis">Root Cause Analysis<a class="headerlink" href="#root-cause-analysis" title="Permanent link">&para;</a></h1>
<ul>
<li><strong>Why was Smart-Foodies-Shop.com down?</strong> - The database directory of
    the database server was removed by accident, instead of removing the
    temporary generated cache.</li>
<li><strong>Why was the database directory removed?</strong> - Database was going to
    be migrated to RDS managed instance, this required testing with the
    latest database snapshot. This, in turn required that the dump
    script had to be updated and manually executed on a production
    database server.</li>
<li><strong>Why did script had to be updated?</strong> - To get rid of client's
    private data, so engineer could test data in a new staging
    environment.</li>
<li><strong>Why did the database load increase?</strong> - This was caused by an
    over-convoluted <code>JOIN</code> query to export latest database snapshot.</li>
</ul>
<h1 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h1>
<h2 id="backup-enhancements">Backup Enhancements<a class="headerlink" href="#backup-enhancements" title="Permanent link">&para;</a></h2>
<p>Backup procedures should definitely be enhanced. One way to accomplish
better recovery is by leveraging LVM volumes and EBS. This might provide
the option to easily increase the size of the volumes by adding more EBS
volumes. With multiple EBS volumes, network performance is increased
between EC2 instances and EBS volumes and also allows you to restore
specific part of your partitions without fetching remote backups. EBS
however can be really slow if not using an S-Tier offering, hence the
disks can be very slow, resulting in them being the main bottleneck in
the restoration process.</p>
<h2 id="migrating-to-rds">Migrating to RDS<a class="headerlink" href="#migrating-to-rds" title="Permanent link">&para;</a></h2>
<p>Even though migration to managed RDS service had ironically been a semi
root cause for entire hick-up, we are still going to switch to a more
sophisticated solution and from now on will treat our production as a
higher class citizen and will try to leverage advanced high availability
setups to prevent future outages and stay fault tolerant even when one
of our worker nodes goes down.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"."}})</script>
      
    
  </body>
</html>